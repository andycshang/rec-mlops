services:
  zookeeper:
    # 替换为 legacy 镜像
    image: bitnamilegacy/zookeeper:3.8.3
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"

  kafka:
    # 替换为 legacy 镜像，版本建议与 Spark 3.4 兼容的 3.4.x
    image: bitnamilegacy/kafka:3.4.1
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      # 保持之前修改过的 Bitnami 专用变量格式
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_BROKER_ID=1
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - ALLOW_PLAINTEXT_LISTENER=yes
    volumes:
      - kafka_data:/bitnami/kafka

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: recommendations
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  mlflow:
    image: python:3.9-slim
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_TRACKING_URI=postgresql://postgres:postgres@postgres:5432/recommendations
    depends_on:
      - postgres
    volumes:
      - ./mlflow_artifacts:/mlflow/artifacts
    command: bash -c "pip install mlflow psycopg2-binary && mlflow server --backend-store-uri postgresql://postgres:postgres@postgres:5432/recommendations --default-artifact-root mlflow-artifacts:/ --artifacts-destination /mlflow/artifacts --host 0.0.0.0 --port 5000 --serve-artifacts"

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - grafana_data:/var/lib/grafana

  spark-master:
    image: bitnamilegacy/spark:3.4.1
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
    ports:
      - "8080:8080"
      - "7077:7077"
    volumes:
      - .:/app  # 将当前根目录挂载到容器的 /app
      - ./data:/data

  spark-worker:
    image: bitnamilegacy/spark:3.4.1
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_CORES=2
    depends_on:
      - spark-master
    volumes:
      - .:/app  # 将当前根目录挂载到容器的 /app
      - ./data:/data
  
  prefect:
    image: prefecthq/prefect:2-latest  # 或使用 3-latest，根据你的 requirements.txt 决定
    ports:
      - "4200:4200"
    command: >
      sh -c "
        prefect server start --host 0.0.0.0 --port 4200
      "
    environment:
      - PREFECT_SERVER_API_HOST=0.0.0.0
      - PREFECT_SERVER_API_PORT=4200
      - PREFECT_UI_URL=http://localhost:4200/api
      - PREFECT_API_URL=http://localhost:4200/api
    volumes:
      - prefect_data:/root/.prefect
    restart: always

volumes:
  postgres_data:
  redis_data:
  grafana_data:
  prefect_data:
  kafka_data:
